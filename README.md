# usergate_response

ug.py - скрипт, который позволяет манипулировать правилами межсетевого экрана, контентного фильтра и списками url и ip-адресов

## Требования

python3.x:
- xmlrpc
- argparse
- json
- os

## Первоначальная настройка

### Настройка Usergate

1. Зайти в веб-интерфейс UserGate под учетной записью администратора. Перейти в `UserGate` – `Администраторы` и в графе `Профили администраторов` выбрать `Добавить`
2. Задать имя профиля, например, `API`. Перейти на вкладку `Разрешения для API` и добавить разрешения на чтение и запись для следующих объектов: `content`, `core`,	`firewall`,	`nlists`. Сохранить изменения
3. В том же разделе в графе `Администраторы` выбрать `Добавить` - `Добавить локального администратора`
4. Задать логин и пароль, а в качестве профиля администратора указать профиль, созданный в предыдущих шагах. Сохранить изменения
5. В строке запроса браузера после адреса и порта UserGate задать `?features=zone-xml-rpc` и нажать `Enter`
6. Перейти в `Сеть` - `Зоны` и для зоны того интерфейса, через который будет осуществляться взаимодействие по API перейти в `Контроль доступа` и поставить галочку напротив `XML-RPC для управления`. В разрешенные адреса при необходимости можно добавить ip-адрес коррелятора KUMA

### Настройка KUMA

1. Поместить скрипт `ug.py` и файл конфигурации `ug.json` на сервер коррелятора KUMA по пути `/opt/kaspersky/kuma/correlator/<id>/scripts/`
2. Назначить kuma владельцем файлов
```
chown kuma:kuma ug.py ug.json
```
3. Дать файлу права на исполнение
```
chmod +x ug.py
```
4. Задать в файле конфигурации адрес UserGate, а также логин и пароль пользователя из шага 4 предыдущего раздела

### Настройка автоматического реагирования

1. Перейти на вкладку `Ресурсы` - `Правила реагирования` и нажать `Добавить реагирование`
2. Задать название правила. В названии скрипта указать `ug.py`
3. В аргументах скрипта указать соответствующую команду, например, `blockurl -i {{.RequestUrl}}`
4. Добавить в правило реагирования условия, соответствующие правилу\правилам корреляции, по сработке которых планируется блокировка URL\IP\domain на UserGate. После чего сохранить правило реагирования
5. Перейти в настройки соответствующего сервиса коррелятора, перейти на п. 5 `Реагирование`. Нажать кнопку `Добавить` и указать сохраненное на шаге 4 правило реагирования
6. Перейти на п. 7 `Проверка параметров` и выбрать `Сохранить и обновить параметры сервисов`
7. Правило реагирования привязано к коррелятору и готово к использованию

## Команды

### blockurl

`-i`, `--item` - URL, который необходимо заблокировать. Обязательный аргумент.

`-r`, `--rule_name` - имя правила контентной фильтрации. По умолчанию: `KUMA Block Suspicious URLs`

`-l`, `--list_name` - имя листа с URL. По умолчанию: `KUMA Suspicious URLs`

_Пример:_
```
ug.py blockurl -i https://badurl.evil/ -r MyRuleName -l MyListName
```

### blockdomain


`-i`, `--item` - доменное имя, которое необходимо заблокировать. Обязательный аргумент.

`-r`, `--rule_name` - имя правила межсетевого экрана. По умолчанию: `KUMA Block Suspicious Domains`

`-l`, `--list_name` - имя листа с доменными именами. По умолчанию: `KUMA Suspicious Domains`

_Пример:_
```
ug.py blockdomain -i baddomain.evil
```

### blockip

`-i`, `--item` - ip-адрес, который необходимо заблокировать. Обязательный аргумент.

`-r`, `--rule_name` - имя правила межсетевого экрана. По умолчанию: `KUMA Block Suspicious IPs`

`-l`, `--list_name` - имя листа с ip-адресами именами. По умолчанию: `KUMA Suspicious IPs`

_Пример:_
```
ug.py blockip -i 10.10.10.10
```

### Примечание
Любая сущность, создаваемая скриптом: правило межсетевого экрана, правило контентной фильтрации, лист URL, лист доменных имен, лист IP - создаются только, если их уже нет на Usergate. В противном случае происходит обновление уже существующих объектов на Usergate.
